# .github/workflows/drafter.yml
name: Draft new release

on:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  release-draft:
    name: Update Draft Release Notes
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set release date
        run: echo "RELEASE_DATE=$(date -u +%Y-%m-%d)" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq gh

      - name: Authenticate gh CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Run Release Drafter
        id: release-drafter
        uses: release-drafter/release-drafter@v6
        with:
          config-name: drafter-config.yaml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Process release notes with PR descriptions
        id: clean-notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_DATE: ${{ env.RELEASE_DATE }}
        run: |
          RELEASE_ID=${{ steps.release-drafter.outputs.id }}
          if [ -z "$RELEASE_ID" ]; then
            echo "No release ID found. Skipping processing."
            exit 0
          fi

          # ì›ë³¸ ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ ê°€ì ¸ì˜¤ê¸°
          BODY=$(gh api repos/${{ github.repository }}/releases/$RELEASE_ID --jq '.body' || echo "")
          if [ -z "$BODY" ]; then
            echo "Could not get release body. Skipping processing."
            exit 0
          fi

          # ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ì—ì„œ PR ë²ˆí˜¸ ì¶”ì¶œ
          echo "Extracting PR numbers from release notes..."
          PR_PATTERN='- \*\*.*\(\#([0-9]+)\).*\*\*'
          PR_NUMBERS=$(echo "$BODY" | grep -oP '\(#\K[0-9]+(?=\))' || echo "")

          if [ -z "$PR_NUMBERS" ]; then
            echo "No PR numbers found in release notes."
          else
            echo "Found PR numbers: $PR_NUMBERS"
            
            # ê° PRì— ëŒ€í•œ ì„¤ëª… ê°€ì ¸ì™€ì„œ ëŒ€ì²´
            for PR_NUM in $PR_NUMBERS; do
              echo "Processing PR #$PR_NUM..."
              
              # PR ì •ë³´ ê°€ì ¸ì˜¤ê¸°
              PR_INFO=$(gh api repos/${{ github.repository }}/pulls/$PR_NUM --jq '{title: .title, body: .body}' 2>/dev/null || echo '{"title":"", "body":""}')
              
              # PR ì œëª©ê³¼ ì„¤ëª… ì¶”ì¶œ
              PR_TITLE=$(echo "$PR_INFO" | jq -r '.title')
              PR_BODY=$(echo "$PR_INFO" | jq -r '.body')
              
              if [ -z "$PR_TITLE" ] || [ "$PR_TITLE" = "null" ]; then
                echo "Could not get title for PR #$PR_NUM. Skipping."
                continue
              fi
              
              # PR ì„¤ëª…ì—ì„œ ìœ íš¨í•œ ë‚´ìš© ì¶”ì¶œ
              DESCRIPTION=$(echo "$PR_BODY" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
              if [ -z "$DESCRIPTION" ] || [ ${#DESCRIPTION} -lt 5 ]; then
                echo "PR #$PR_NUM has no valid description. Using title instead."
                DESCRIPTION="$PR_TITLE"
              else
                # PR ì„¤ëª… ì „ì²´ ì‚¬ìš© (ì¤„ë°”ê¿ˆì€ ê³µë°±ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ í¬ë§· ìœ ì§€)
                DESCRIPTION=$(echo "$DESCRIPTION" | tr '\n' ' ' | sed 's/  / /g')
                
                # ì„¤ëª…ì´ ë„ˆë¬´ ê¸¸ë©´ ìë¥´ê¸° (300ì ì œí•œ)
                if [ ${#DESCRIPTION} -gt 300 ]; then
                  DESCRIPTION="${DESCRIPTION:0:297}..."
                fi
              fi
              
              # PR ì œëª©ì„ ì„¤ëª…ìœ¼ë¡œ ëŒ€ì²´ (ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬ í•„ìš”)
              PR_TITLE_ESCAPED=$(echo "$PR_TITLE" | sed 's/[\/&]/\\&/g')
              DESCRIPTION_ESCAPED=$(echo "$DESCRIPTION" | sed 's/[\/&]/\\&/g')
              
              echo "Replacing title with description for PR #$PR_NUM"
              BODY=$(echo "$BODY" | sed "s/- \*\*$PR_TITLE_ESCAPED\( \)\?(#$PR_NUM).*\*\*/- **$DESCRIPTION_ESCAPED (#$PR_NUM)**/g")
            done
          fi

          # ì ‘ë‘ì‚¬ ì œê±° ë° ë‚ ì§œ í”Œë ˆì´ìŠ¤í™€ë” ì¹˜í™˜
          PROCESSED_BODY=$(echo "$BODY" \
            | sed 's/\[[A-Za-z0-9_-]\+\] //g' \
            | sed "s/RELEASE_DATE_PLACEHOLDER/$RELEASE_DATE/g"
          )

          # ìˆ˜ì •ëœ ë‚´ìš©ìœ¼ë¡œ ë¦´ë¦¬ìŠ¤ ì—…ë°ì´íŠ¸
          echo "Updating GitHub release with processed content..."
          gh api repos/${{ github.repository }}/releases/$RELEASE_ID -X PATCH -F body="$PROCESSED_BODY"

          # ì²˜ë¦¬ëœ ë‚´ìš©ì„ outputìœ¼ë¡œ ë‚´ë³´ë‚´ê¸°
          echo "cleaned_body<<EOF" >> $GITHUB_OUTPUT
          echo "$PROCESSED_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send to Slack
        if: success() && steps.release-drafter.outputs.id
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          RELEASE_VERSION: ${{ steps.release-drafter.outputs.tag_name }}
          RELEASE_URL: ${{ steps.release-drafter.outputs.html_url }}
          RELEASE_DATE: ${{ env.RELEASE_DATE }}
          RELEASE_BODY: ${{ steps.clean-notes.outputs.cleaned_body }}
        run: |
          # Slack í˜¸í™˜ì„ ìœ„í•´ Markdown í—¤ë”(#)ë¥¼ ë³¼ë“œì²´(*í…ìŠ¤íŠ¸*)ë¡œ ì¹˜í™˜
          SLACK_BODY=$(echo "$RELEASE_BODY" | \
            sed 's/^### \(.*\)/*\1*/g; s/^## \(.*\)/*\1*/g; s/^# \(.*\)/*\1*/g' | \
            sed 's/\*\*//g')

          # 1500ì ì´ìƒì´ë©´ ìë¥´ê³  ì•ˆë‚´ ë¬¸êµ¬ ë§ë¶™ì´ê¸°
          if [ ${#SLACK_BODY} -gt 1500 ]; then
            SLACK_BODY="${SLACK_BODY:0:1500}...\n(ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ê°€ ì˜ë ¸ìŠµë‹ˆë‹¤. ì „ì²´ ë‚´ìš©ì€ GitHubì—ì„œ í™•ì¸í•˜ì„¸ìš”)"
          fi

          # jq ë¡œ JSON ì¡°ë¦½ (ë³€ìˆ˜ê°’ ìë™ìœ¼ë¡œ ì´ìŠ¤ì¼€ì´í”„ ë¨)
          SLACK_PAYLOAD=$(jq -n \
            --arg text "ğŸ‰ ìƒˆ ë¦´ë¦¬ìŠ¤ ë°°í¬: $RELEASE_VERSION" \
            --arg version "$RELEASE_VERSION" \
            --arg date "$RELEASE_DATE" \
            --arg url "$RELEASE_URL" \
            --arg body "$SLACK_BODY" \
            '{
              text: $text,
              attachments: [
                {
                  color: "#36a64f",
                  pretext: "ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸:",
                  title: "\($version) (\($date))",
                  title_link: $url,
                  text: $body,
                  footer: "GitHub Release",
                  footer_icon: "https://github.githubassets.com/favicon.ico"
                }
              ]
            }'
          )

          # ë””ë²„ê¹…: í˜ì´ë¡œë“œ ì¶œë ¥
          echo "$SLACK_PAYLOAD" | jq .

          # ì‹¤ì œ ì „ì†¡
          curl -X POST -H 'Content-Type: application/json' --data "$SLACK_PAYLOAD" "$SLACK_WEBHOOK_URL"
