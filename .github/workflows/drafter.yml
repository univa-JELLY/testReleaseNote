name: PR to Slack

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  notify-slack:
    # PRì´ ë¨¸ì§€ëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Set current date
        run: echo "CURRENT_DATE=$(date -u +\"%Y-%m-%d\")" >> $GITHUB_ENV

      - name: Get PR info
        id: pr-info
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_BODY="${{ github.event.pull_request.body }}"

          if [ -z "$PR_BODY" ] || [ $(echo "$PR_BODY" | xargs | wc -c) -lt 5 ]; then
            # ë³¸ë¬¸ì´ ì—†ìœ¼ë©´ ì œëª©ì„ ì‚¬ìš©
            echo "PR_CONTENT=$PR_TITLE" >> $GITHUB_OUTPUT
          else
            PR_CONTENT=$(echo "$PR_BODY" | tr '\n' ' ' | sed 's/  */ /g' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
            if [ ${#PR_CONTENT} -gt 1000 ]; then
              PR_CONTENT="${PR_CONTENT:0:997}..."
            fi
            echo "PR_CONTENT<<EOF" >> $GITHUB_OUTPUT
            echo "$PR_CONTENT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Send to Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          PR_CONTENT: ${{ steps.pr-info.outputs.PR_CONTENT }}
          CURRENT_DATE: ${{ env.CURRENT_DATE }}
        run: |
          # í˜„ì¬ ë‚ ì§œ í˜•ì‹ ë³€í™˜ (YYYY-MM-DD â†’ YYYY.MM.DD)
          FORMATTED_DATE=$(echo "$CURRENT_DATE" | tr -d '"' | sed 's/-/./g')

          # PR ì„¤ëª… ê·¸ëŒ€ë¡œ ì‚¬ìš© (ë¶ˆë¦¿ í¬ì¸íŠ¸ ì¶”ê°€ ì—†ì´)
          echo "$PR_CONTENT" > bullet_points.txt

          # jqë¥¼ ì‚¬ìš©í•˜ì—¬ ì•ˆì „í•˜ê²Œ JSON ìƒì„± (ì´ìŠ¤ì¼€ì´í”„ ìë™ ì²˜ë¦¬)
          SLACK_PAYLOAD=$(jq -n \
            --rawfile content bullet_points.txt \
            --arg title "ğŸ“¦ ë¬¸ì œG ë¦´ë¦¬ì¦ˆë…¸íŠ¸ ($FORMATTED_DATE)" \
            '{
              attachments: [
                {
                  color: "#36a64f",
                  title: $title,
                  text: $content,
                  mrkdwn_in: ["text"]
                }
              ]
            }'
          )

          # ë””ë²„ê¹…
          echo "ë‚ ì§œ: $FORMATTED_DATE"
          echo "ë‚´ìš©:"
          cat bullet_points.txt

          # ì „ì†¡
          curl -X POST -H 'Content-Type: application/json' --data "$SLACK_PAYLOAD" "$SLACK_WEBHOOK_URL"
