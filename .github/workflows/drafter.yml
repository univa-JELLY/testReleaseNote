name: PR to Slack

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  notify-slack:
    # PRμ΄ λ¨Έμ§€λ κ²½μ°μ—λ§ μ‹¤ν–‰
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Set current date
        run: echo "CURRENT_DATE=$(date -u +\"%Y-%m-%d\")" >> $GITHUB_ENV

      - name: Get PR info
        id: pr-info
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_BODY="${{ github.event.pull_request.body }}"

          if [ -z "$PR_BODY" ] || [ $(echo "$PR_BODY" | xargs | wc -c) -lt 5 ]; then
            # λ³Έλ¬Έμ΄ μ—†μΌλ©΄ μ λ©μ„ μ‚¬μ©
            echo "PR_CONTENT=$PR_TITLE" >> $GITHUB_OUTPUT
          else
            PR_CONTENT=$(echo "$PR_BODY" | tr '\n' ' ' | sed 's/  */ /g' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
            if [ ${#PR_CONTENT} -gt 1000 ]; then
              PR_CONTENT="${PR_CONTENT:0:997}..."
            fi
            echo "PR_CONTENT<<EOF" >> $GITHUB_OUTPUT
            echo "$PR_CONTENT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Send to Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          PR_CONTENT: ${{ steps.pr-info.outputs.PR_CONTENT }}
          CURRENT_DATE: ${{ env.CURRENT_DATE }}
        run: |
          # ν„μ¬ λ‚ μ§ ν•μ‹ λ³€ν™ (YYYY-MM-DD β†’ YYYY.MM.DD)
          FORMATTED_DATE=$(echo "$CURRENT_DATE" | tr -d '"' | sed 's/-/./g')

          # PR μ„¤λ… λ³€ν™
          BULLET_LIST=$(echo "$PR_CONTENT" | sed 's/\\n/\n/g' | sed '/^\s*$/d' | sed -e 's/^[[:space:]]*/- /' | sed -e 's/^- - /- /')

          # λ¶ν•„μ”ν• λΉ λ¶λ¦Ώ ν¬μΈνΈ μ κ±°
          FORMATTED_CONTENT=$(echo "$BULLET_LIST" | grep -v '^- $')

          # μ¤„λ°”κΏ λ¬Έμλ¥Ό JSONμ—μ„ μ‚¬μ© κ°€λ¥ν• ν•νƒλ΅ μΉν™
          ESCAPED_CONTENT=$(echo "$FORMATTED_CONTENT" | sed ':a;N;$!ba;s/\n/\\n/g' | sed 's/"/\\"/g')

          # JSON νμ΄λ΅λ“ μ§μ ‘ μƒμ„±
          SLACK_PAYLOAD='{"attachments":[{"color":"#36a64f","title":"π“¦ λ¬Έμ G λ¦΄λ¦¬μ¦λ…ΈνΈ ('$FORMATTED_DATE')","text":"'"$ESCAPED_CONTENT"'","mrkdwn_in":["text"]}]}'

          # λ””λ²„κΉ… (λ¬Έμ  ν•΄κ²°μ— λ„μ›€μ΄ λ¨)
          echo "λ‚ μ§: $FORMATTED_DATE"
          echo "λ‚΄μ©:"
          echo "$FORMATTED_CONTENT"

          # μ „μ†΅
          curl -X POST -H 'Content-Type: application/json' --data "$SLACK_PAYLOAD" "$SLACK_WEBHOOK_URL"
