# .github/workflows/drafter.yml
name: Draft new release

on:
  push:
    branches:
      - main

jobs:
  release-draft:
    name: Update Draft Release Notes
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set release date
        run: echo "RELEASE_DATE=$(date -u +"%Y-%m-%d")" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          sudo apt-get install -y gh

      - name: Authenticate gh CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Run Release Drafter
        id: release-drafter
        uses: release-drafter/release-drafter@v6
        with:
          config-name: drafter-config.yaml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Clean up release notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_DATE: ${{ env.RELEASE_DATE }}
        run: |
          # Release Drafterì˜ ì¶œë ¥ì—ì„œ ë¦´ë¦¬ìŠ¤ ID ì§ì ‘ ì‚¬ìš©
          RELEASE_ID=${{ steps.release-drafter.outputs.id }}
          if [ -z "$RELEASE_ID" ]; then
            echo "No release ID found. Skipping cleanup."
            exit 0
          fi

          echo "Using release ID: $RELEASE_ID"
          echo "Current date: $RELEASE_DATE"

          # ë¦´ë¦¬ìŠ¤ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ë“œë˜í”„íŠ¸ í¬í•¨)
          BODY=$(gh api repos/${{ github.repository }}/releases/$RELEASE_ID --jq '.body' || echo "")
          if [ -z "$BODY" ]; then
            echo "Could not get release body. Skipping cleanup."
            exit 0
          fi

          # ëª¨ë“  ìœ í˜•ì˜ ì ‘ë‘ì‚¬ ì œê±° ([FEAT], [MODIFY], [FIX] ë“±)
          CLEANED_BODY=$(echo "$BODY" | sed 's/\[[A-Za-z0-9_-]\+\] //g')

          # ë‚ ì§œ í”Œë ˆì´ìŠ¤í™€ë” ëŒ€ì²´
          CLEANED_BODY=$(echo "$CLEANED_BODY" | sed "s/RELEASE_DATE_PLACEHOLDER/$RELEASE_DATE/g")

          # ìˆ˜ì •ëœ ë‚´ìš©ìœ¼ë¡œ ë¦´ë¦¬ìŠ¤ ì—…ë°ì´íŠ¸
          echo "Updating release notes for ID: $RELEASE_ID"
          gh api repos/${{ github.repository }}/releases/$RELEASE_ID -X PATCH -F body="$CLEANED_BODY"

      - name: Send to Slack
        if: success() && steps.release-drafter.outputs.id
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          RELEASE_ID: ${{ steps.release-drafter.outputs.id }}
          RELEASE_VERSION: ${{ steps.release-drafter.outputs.tag_name }}
          RELEASE_URL: ${{ steps.release-drafter.outputs.html_url }}
        run: |
          # ì •ë¦¬ëœ ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ ë‚´ìš© ì‚¬ìš©
          RELEASE_BODY="${CLEANED_BODY}"

          # Slack ë©”ì‹œì§€ í¬ë§·íŒ…
          SLACK_MESSAGE=$(cat << EOF
          {
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "ğŸ‰ ìƒˆ ë¦´ë¦¬ì¦ˆ ë°œí–‰: ${RELEASE_VERSION}"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*ë°œí–‰ì¼:* ${RELEASE_DATE}"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "${RELEASE_BODY}"
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "GitHubì—ì„œ ë³´ê¸°"
                    },
                    "url": "${RELEASE_URL}"
                  }
                ]
              }
            ]
          }
          EOF
          )

          # Slackì— ë©”ì‹œì§€ ì „ì†¡
          curl -X POST -H 'Content-type: application/json' --data "${SLACK_MESSAGE}" "${SLACK_WEBHOOK_URL}"
