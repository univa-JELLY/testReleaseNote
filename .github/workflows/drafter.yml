# .github/workflows/drafter.yml
name: Draft new release

on:
  push:
    branches:
      - main

jobs:
  release-draft:
    name: Update Draft Release Notes
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set release date
        run: echo "RELEASE_DATE=$(date -u +\"%Y-%m-%d\")" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq gh

      - name: Authenticate gh CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Run Release Drafter
        id: release-drafter
        uses: release-drafter/release-drafter@v6
        with:
          config-name: drafter-config.yaml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Clean up release notes
        id: clean-notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_DATE: ${{ env.RELEASE_DATE }}
        run: |
          RELEASE_ID=${{ steps.release-drafter.outputs.id }}
          if [ -z "$RELEASE_ID" ]; then
            echo "No release ID found. Skipping cleanup."
            exit 0
          fi

          # ì›ë³¸ ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ ê°€ì ¸ì˜¤ê¸°
          BODY=$(gh api repos/${{ github.repository }}/releases/$RELEASE_ID --jq '.body' || echo "")
          if [ -z "$BODY" ]; then
            echo "Could not get release body. Skipping cleanup."
            exit 0
          fi

          # ì ‘ë‘ì‚¬ ì œê±° ë° ë‚ ì§œ í”Œë ˆì´ìŠ¤í™€ë” ì¹˜í™˜
          CLEANED_BODY=$(echo "$BODY" \
            | sed 's/\[[A-Za-z0-9_-]\+\] //g' \
            | sed "s/RELEASE_DATE_PLACEHOLDER/$RELEASE_DATE/g"
          )

          # cleaned_bodyë¥¼ outputìœ¼ë¡œ ë‚´ë³´ë‚´ê¸°
          echo "cleaned_body<<EOF" >> $GITHUB_OUTPUT
          echo "$CLEANED_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send to Slack
        if: success() && steps.release-drafter.outputs.id
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          RELEASE_VERSION: ${{ steps.release-drafter.outputs.tag_name }}
          RELEASE_URL: ${{ steps.release-drafter.outputs.html_url }}
          RELEASE_DATE: ${{ env.RELEASE_DATE }}
          RELEASE_BODY: ${{ steps.clean-notes.outputs.cleaned_body }}
        run: |
          # ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ ë§ˆí¬ë‹¤ìš´ í¬ë§· ë³€í™˜ (Slack í˜¸í™˜ì„± í–¥ìƒ)
          SLACK_BODY=$(echo "$RELEASE_BODY" | sed 's/###/*/g' | sed 's/##/*/g' | sed 's/#/*/g')

          # 1. ê¸¸ì´ ì œí•œ (1500ì - Slack ì œí•œì— ì•ˆì „í•œ ë²”ìœ„)
          TRIMMED_BODY=$(echo "$SLACK_BODY" | cut -c1-1500)
          if [ ${#SLACK_BODY} -gt 1500 ]; then
            TRIMMED_BODY="${TRIMMED_BODY}...\n(ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ê°€ ì˜ë ¸ìŠµë‹ˆë‹¤. ì „ì²´ ë‚´ìš©ì€ GitHubì—ì„œ í™•ì¸í•˜ì„¸ìš”)"
          fi

          # ê°„ë‹¨í•œ í…ìŠ¤íŠ¸ ë©”ì‹œì§€ë¡œ ëŒ€ì²´ - ë” ì•ˆì •ì ì¸ ë°©ì‹
          SLACK_PAYLOAD='{
            "text": "ğŸ‰ ìƒˆ ë¦´ë¦¬ìŠ¤ ë°°í¬: '"${RELEASE_VERSION}"'",
            "attachments": [
              {
                "color": "#36a64f",
                "pretext": "ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸:",
                "title": "'"${RELEASE_VERSION}"' ('"${RELEASE_DATE}"')",
                "title_link": "'"${RELEASE_URL}"'",
                "text": "'"${TRIMMED_BODY//$'\n'/\\n}"'",
                "footer": "GitHub Release",
                "footer_icon": "https://github.githubassets.com/favicon.ico"
              }
            ]
          }'

          # í˜ì´ë¡œë“œ ë””ë²„ê·¸ ì •ë³´ ì¶œë ¥
          echo "Sending slack notification..."

          # ë©”ì‹œì§€ ì „ì†¡
          curl -X POST -H 'Content-Type: application/json' --data "$SLACK_PAYLOAD" "$SLACK_WEBHOOK_URL" -v || echo "Slack ì „ì†¡ ì‹¤íŒ¨: $?"
